#!/bin/bash

# ==============================================================================
# [설정 정보]
# ==============================================================================
DB_USER="admin"
DB_PASS="1234"
DB_NAME="hospital_db"

# ==============================================================================
# [로직 시작]
# ==============================================================================

# 1. 인자($1)가 있는지 확인
if [ -n "$1" ]; then
    # 인자가 있으면 그걸 파일명으로 사용
    SQL_FILE="$1"
else
    # 2. 인자가 없으면 파일 선택 메뉴 출력
    echo "----------------------------------------"
    echo " 현재 디렉토리의 SQL 파일 목록"
    echo "----------------------------------------"
    
    # .sql 파일들을 배열에 담음
    file_list=( *.sql )
    
    # 파일이 하나도 없으면 종료
    if [ ${#file_list[@]} -eq 0 ] || [ ! -e "${file_list[0]}" ]; then
        echo "[에러] .sql 파일이 하나도 없습니다!"
        exit 1
    fi

    # 목록 출력
    i=1
    for f in "${file_list[@]}"; do
        echo "$i) $f"
        ((i++))
    done
    echo "----------------------------------------"

    # 사용자 입력 받기
    read -p "적용할 파일 번호를 선택하세요: " file_num

    # 입력값 검증 (숫자인지, 범위 내인지)
    # 배열 인덱스는 0부터 시작하므로 (입력값 - 1)
    idx=$((file_num-1))

    if [ -z "${file_list[$idx]}" ]; then
        echo "[에러] 잘못된 번호입니다."
        exit 1
    fi

    # 선택된 파일명 저장
    SQL_FILE="${file_list[$idx]}"
fi

# ==============================================================================
# [실행 단계]
# ==============================================================================

# 파일 존재 여부 최종 확인
if [ ! -f "$SQL_FILE" ]; then
    echo "[에러] '$SQL_FILE' 파일을 찾을 수 없습니다!"
    exit 1
fi

echo ""
echo ">>> 선택된 파일: $SQL_FILE"
echo ">>> 데이터베이스($DB_NAME)에 적용을 시작합니다..."

# DB 생성 (없으면 생성)
mysql -u$DB_USER -p$DB_PASS -e "CREATE DATABASE IF NOT EXISTS $DB_NAME"

# SQL 파일 import
mysql -u$DB_USER -p$DB_PASS $DB_NAME < "$SQL_FILE"

if [ $? -eq 0 ]; then
    echo ">>> [성공] DB 초기화가 완료되었습니다! 🎉"
else
    echo ">>> [실패] DB 적용 중 오류가 발생했습니다."
fi